{% extends "base.html" %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <h2>Productos</h2>
  {% if user.is_staff %}
    <a class="btn btn-primary" href="{% url 'productos:create' %}">Crear producto</a>
  {% endif %}
</div>
<div class="row g-3">
  {% for p in productos %}
  <div class="col-md-4">
    <div class="card h-100">
      <div class="card-body d-flex flex-column">
        <h5 class="card-title">{{ p.nombre }}</h5>
        <p class="mb-1 small text-muted">{{ p.categoria.nombre }}</p>
        <p class="mb-2">Precio: <strong>${{ p.precio }}</strong></p>
        <p class="mb-3">{{ p.descripcion|truncatewords:20 }}</p>
        <div class="mt-auto">
          <div class="small text-muted">Stock disponible: <span class="stock-label">{{ p.stock }}</span></div>
          {% if p.stock > 0 %}
          <div class="d-flex align-items-center gap-2 mt-2">
            <input type="number" class="form-control form-control-sm qty-input" data-product-id="{{ p.pk }}" min="1" max="{{ p.stock }}" value="1" style="max-width:90px;">
            <button class="btn btn-sm btn-success comprar-btn" data-product-id="{{ p.pk }}" data-url="/api/productos/{{ p.pk }}/comprar/">Comprar</button>
            <form method="post" action="{% url 'productos:add_to_cart' p.pk %}" class="d-flex gap-2 align-items-center mt-2">
              {% csrf_token %}
              <input
                type="number"
                name="cantidad"
                min="1"
                max="{{ p.stock }}"
                value="1"
                class="form-control form-control-sm w-auto"
                aria-label="Cantidad para {{ p.nombre }}"
              />
              <button class="btn btn-primary btn-sm">Agregar al carrito</button>
            </form>
          </div>
          {% else %}
          <div class="mt-2 text-danger small">Sin stock</div>
          {% endif %}
          <div class="d-flex justify-content-between align-items-center mt-3">
            <a class="btn btn-sm btn-outline-primary" href="{% url 'productos:detail' p.pk %}">Ver</a>
            {% if user.is_staff %}
              <div>
                <a class="btn btn-sm btn-secondary" href="{% url 'productos:update' p.pk %}">Editar</a>
                <form method="post" action="{% url 'productos:delete' p.pk %}" class="d-inline">
                  {% csrf_token %}
                  <button class="btn btn-sm btn-danger" type="submit">Eliminar</button>
                </form>
              </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
  {% empty %}
  <div class="col-12"><p>No hay productos disponibles.</p></div>
  {% endfor %}
</div>

<script>
(function(){
  const getCSRF = typeof getCookie === 'function'
    ? getCookie
    : (name) => {
        const m = document.cookie.match(new RegExp('(^|;)\\s*' + name + '=([^;]+)'));
        return m ? decodeURIComponent(m[2]) : null;
      };

  document.addEventListener('click', function(e){
    const btn = e.target.closest('.comprar-btn');
    if(!btn) return;
    const card = btn.closest('.card');
    const input = card?.querySelector('.qty-input[data-product-id="' + btn.dataset.productId + '"]');
    const cantidad = input ? parseInt(input.value, 10) : 1;
    if(!cantidad || cantidad <= 0){
      Swal.fire({icon:'error', title:'Cantidad invÃ¡lida', text:'Ingresa una cantidad mayor a 0.'});
      return;
    }

    fetch(btn.dataset.url, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCSRF('csrftoken'),
      },
      body: JSON.stringify({ cantidad }),
    })
    .then(async r => {
      const data = await r.json().catch(() => ({}));
      if(!r.ok) throw new Error(data.detail || 'No se pudo completar la compra.');
      return data;
    })
    .then(data => {
      Swal.fire({icon:'success', title: data.detail || 'Compra realizada', text: 'Stock restante: ' + data.stock_restante});
      const stockLabel = card?.querySelector('.stock-label');
      if(stockLabel) stockLabel.textContent = data.stock_restante;
      if(input){
        input.max = data.stock_restante;
        if(data.stock_restante <= 0) {
          input.value = 0;
          btn.disabled = true;
          btn.classList.add('disabled');
        } else if(parseInt(input.value,10) > data.stock_restante){
          input.value = data.stock_restante;
        }
      }
    })
    .catch(err => {
      Swal.fire({icon:'error', title:'Error', text: err.message});
    });
  });
})();
</script>
{% endblock %}
